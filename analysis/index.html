
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CÃ­rculo HarmÃ´nico â€” TÃ©trades (4 notas)</title>
<link rel="stylesheet" href="style.css">

</head>
<body>

<h1>ðŸŽ¶ CÃ­rculo HarmÃ´nico â€” TÃ©trades (4 notas)</h1>

<div class="controls">
  <label for="modeSelect">Modo:</label>
  <select id="modeSelect">
    <option value="major">Maior (JÃ´nio)</option>
    <option value="minor">Menor Natural (EÃ³lio)</option>
    <option value="harmonicMinor">Menor HarmÃ´nica</option>
    <option value="melodicMinor">Menor MelÃ³dica (asc.)</option>
  </select>
  <button id="regen">Gerar</button>
</div>

<div class="circle-container" id="circleContainer"></div>

<div class="scale-display">
  <h3>Notas da escala</h3>
  <p id="currentScale" style="font-weight:600;margin-bottom:.5em;"></p>
  <div id="scaleNotes" class="notes"></div>
</div>

<div class="chords-display">
  <h3>Acordes diatÃ´nicos por grau (tÃ©trades)</h3>
  <div id="chordsGrid" class="degree-row"></div>
</div>

<footer>TÃ©trades fixas: cada acorde mostra 4 notas (ex.: Cm7, Dm7â™­5, Fmaj7, G7...). NotaÃ§Ã£o â™¯/â™­ escolhida por tonalidade.</footer>

<script>
/* ===== Dados musicais ===== */
const MAJOR_KEYS = ["C","G","D","A","E","B","F#","C#","G#","D#","A#","F"];
const MINOR_RELATIVES = ["Am","Em","Bm","F#m","C#m","G#m","D#m","A#m","Fm","Cm","Gm","Dm"];

const CHROMATIC = [
  {s:"C",  f:"C"}, {s:"C#", f:"Db"}, {s:"D",  f:"D"}, {s:"D#", f:"Eb"},
  {s:"E",  f:"E"}, {s:"F",  f:"F"}, {s:"F#", f:"Gb"}, {s:"G",  f:"G"},
  {s:"G#", f:"Ab"}, {s:"A",  f:"A"}, {s:"A#", f:"Bb"}, {s:"B",  f:"B"}
];

const MODES = {
  major: [2,2,1,2,2,2,1],
  minor: [2,1,2,2,1,2,2],
  harmonicMinor: [2,1,2,2,1,3,1],
  melodicMinor: [2,1,2,2,2,2,1]
};

const DEGREE_LABELS_MAJOR = ["I","ii","iii","IV","V","vi","vii\u00B0"];
const DEGREE_LABELS_MINOR = ["i","ii\u00B0","III","iv","v","VI","VII"];

// CÃ­rculo de quintas para acidentes
const SHARP_ORDER = ['F','C','G','D','A','E','B'];
const FLAT_ORDER  = ['B','E','A','D','G','C','F'];

function accidentCount(key, mode) {
  const majorMap = {"C":0,"G":1,"D":2,"A":3,"E":4,"B":5,"F#":6,"C#":7,"F":-1,"Bb":-2,"Eb":-3,"Ab":-4,"Db":-5,"Gb":-6,"Cb":-7};
  const minorMap = {"A":0,"E":1,"B":2,"F#":3,"C#":4,"G#":5,"D#":6,"A#":7,"D":-1,"G":-2,"C":-3,"F":-4,"Bb":-5,"Eb":-6,"Ab":-7};
  const map = mode.includes("minor") ? minorMap : majorMap;
  const val = map[key] || 0;
  if(val>0) return {accidental:"â™¯", count:val};
  if(val<0) return {accidental:"â™­", count:-val};
  return {accidental:null, count:0};
}

function findChromaticIndex(name) {
  const n = name.replace('â™¯','#').replace('â™­','b');
  for(let i=0;i<12;i++) if(CHROMATIC[i].s===n || CHROMATIC[i].f===n) return i;
  return -1;
}

function correctNoteForKey(note, useFlats){
  const idx = findChromaticIndex(note);
  if(idx===-1) return note;
  return useFlats ? CHROMATIC[idx].f : CHROMATIC[idx].s;
}

function buildScale(root, modeName, useFlats=false) {
  const rootBase = root.replace(/m$/, '');
  let start = findChromaticIndex(rootBase);
  if(start===-1) start=0;
  const pattern = MODES[modeName];
  const scale = [correctNoteForKey(rootBase,useFlats)];
  let idx = start;
  for(let step of pattern){
    idx = (idx+step)%12;
    scale.push(correctNoteForKey(CHROMATIC[idx].s,useFlats));
  }
  scale.pop();
  return scale;
}

function buildTetradFromScale(scale, degreeIndex){
  const root = scale[degreeIndex];
  const third = scale[(degreeIndex+2)%7];
  const fifth = scale[(degreeIndex+4)%7];
  const seventh = scale[(degreeIndex+6)%7];

  const rootIdx = findChromaticIndex(root);
  const thirdIdx = findChromaticIndex(third);
  const fifthIdx = findChromaticIndex(fifth);
  const seventhIdx = findChromaticIndex(seventh);

  const interval = (a,b)=>((b-a+12)%12);
  const thirdInt = interval(rootIdx, thirdIdx);
  const fifthInt = interval(rootIdx, fifthIdx);
  const seventhInt = interval(rootIdx, seventhIdx);

  let triadLabel="";
  if(thirdInt===4 && fifthInt===7) triadLabel="";       
  else if(thirdInt===3 && fifthInt===7) triadLabel="m"; 
  else if(thirdInt===3 && fifthInt===6) triadLabel="Â°"; 
  else if(thirdInt===4 && fifthInt===8) triadLabel="aug"; 

  let seventhLabel="";
  if(selectedMode==="harmonicMinor" && degreeIndex===4){ 
      triadLabel=""; 
      seventhLabel="7"; 
  } else {
      if(triadLabel==="") seventhLabel=(seventhInt===11)?"maj7":"7";
      else if(triadLabel==="m") seventhLabel="m7";
      else if(triadLabel==="Â°") seventhLabel="m7b5";
      else seventhLabel="7";
  }

  let chordName = root;
  if(triadLabel==="m" || triadLabel==="Â°" || triadLabel==="aug") chordName += triadLabel;
  chordName += seventhLabel;

  const notes=[root,third,fifth,seventh];
  return {name:chordName, notes};
}

/* ===== UI e renderizaÃ§Ã£o ===== */
const circleContainer=document.getElementById('circleContainer');
const modeSelect=document.getElementById('modeSelect');
const regenBtn=document.getElementById('regen');
const scaleNotesDiv=document.getElementById('scaleNotes');
const chordsGrid=document.getElementById('chordsGrid');

let selectedKey="C";
let selectedMode=modeSelect.value;

function drawCircle(){
  circleContainer.innerHTML='';
  const outerR=150, innerR=100, cx=190, cy=190;



  for(let i=0;i<12;i++){
    const angle=(i/12)*2*Math.PI-Math.PI/2;

    const x=cx+outerR*Math.cos(angle)-32.5;
    const y=cy+outerR*Math.sin(angle)-32.5;
    const major=document.createElement('button');
    major.className='note-btn major';
    major.style.left=x+'px';
    major.style.top=y+'px';

    const acc = accidentCount(MAJOR_KEYS[i],'major');
    major.textContent = correctNoteForKey(MAJOR_KEYS[i], acc.accidental==='â™­');
    major.onclick=()=>{
      selectedKey=MAJOR_KEYS[i];
      selectedMode='major';
      modeSelect.value='major';
      renderAll();
    };
    circleContainer.appendChild(major);

    const x2=cx+innerR*Math.cos(angle)-32.5;
    const y2=cy+innerR*Math.sin(angle)-32.5;
    const minor=document.createElement('button');
    minor.className='note-btn minor';
    minor.style.left=x2+'px';
    minor.style.top=y2+'px';

    const accMinor = accidentCount(MINOR_RELATIVES[i].replace(/m$/,''),'minor');
    minor.textContent = correctNoteForKey(MINOR_RELATIVES[i].replace(/m$/,''), accMinor.accidental==='â™­')+'m';
    minor.onclick=()=>{
      selectedKey=MINOR_RELATIVES[i].replace(/m$/,'');
      if(!["minor","harmonicMinor","melodicMinor"].includes(selectedMode)){
        selectedMode='minor';
        modeSelect.value='minor';
      } else {
        modeSelect.value=selectedMode;
      }
      renderAll();
    };
    circleContainer.appendChild(minor);
  }

  highlightActive();
}

function highlightActive(){
  document.querySelectorAll('.note-btn').forEach(b=>b.classList.remove('active'));
  if(selectedMode==='major'){
    document.querySelectorAll('.note-btn.major').forEach(btn=>{
      if(btn.textContent.replace(/[â™¯â™­]/,'')===selectedKey) btn.classList.add('active');
    });
  } else {
    document.querySelectorAll('.note-btn.minor').forEach(btn=>{
      if(btn.textContent.replace(/[â™¯â™­m]/,'')===selectedKey) btn.classList.add('active');
    });
  }
}

function renderAll(){
  scaleNotesDiv.innerHTML='';

  const acc = accidentCount(selectedKey, selectedMode);
  const useFlats = acc.accidental==='â™­';
  const scale = buildScale(selectedKey, selectedMode, useFlats);

  const label = `${selectedKey} â€” ${modeSelect.options[modeSelect.selectedIndex].text}` +
                (acc.accidental?` (${acc.count} ${acc.accidental})`:'');
  document.getElementById('currentScale').textContent=label;

  // Notas horizontais
  const notesRow = document.createElement('div');
  notesRow.style.display='flex';
  notesRow.style.gap='0.6em';
  scale.forEach(n=>{
    const el=document.createElement('div');
    el.className='note';
    el.textContent=n;
    notesRow.appendChild(el);
  });
  scaleNotesDiv.appendChild(notesRow);

  // Acordes
  chordsGrid.innerHTML='';
  const degreeLabels = selectedMode.includes('minor')? DEGREE_LABELS_MINOR : DEGREE_LABELS_MAJOR;
  for(let d=0;d<7;d++){
    const col=document.createElement('div'); col.className='col';
    const degree=document.createElement('div'); degree.className='hdr'; degree.textContent=degreeLabels[d];

    const chord = buildTetradFromScale(scale,d);
    const chordNameDiv=document.createElement('div'); chordNameDiv.className='chordname'; chordNameDiv.textContent=chord.name;
    const notesDiv=document.createElement('div'); notesDiv.className='noteslist'; notesDiv.textContent=chord.notes.join(' - ');

    col.appendChild(degree);
    col.appendChild(chordNameDiv);
    col.appendChild(notesDiv);

    chordsGrid.appendChild(col);
  }

  highlightActive();
}

/* listeners */
modeSelect.addEventListener('change',()=>{
  selectedMode=modeSelect.value;
  renderAll();
});
regenBtn.addEventListener('click',()=>renderAll());

/* inicializaÃ§Ã£o */
drawCircle();
renderAll();
</script>

</body>
</html>
