<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Pega-pega harmônico</title>
<style>

    html, body {
  touch-action: manipulation;
  overscroll-behavior: none;
}
  html, body {
    margin: 0; padding: 0;
    background-color: black;
    color: white;
    font-family: Arial, sans-serif;
    overflow-x: hidden;
    text-align: center;
  }
  #gameCanvas {
    width: 90vw;
    max-width: 640px;
    aspect-ratio: 1 / 1;
    display: block;
    margin: 10px auto;
    background-color: black;
  }
  #score {
    font-size: max(4vw, 16px);
    margin: 5px 0;
  }
  #gameOverOverlay, #startOverlay {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 10px;
    box-sizing: border-box;
    z-index: 10;
  }
  #gameOverOverlay {
    background: rgba(0, 0, 0, 0.7);
    color: yellow;
    font-size: max(8vw, 20px);
    visibility: hidden;
  }
  #startOverlay {
    background: rgba(0, 0, 0, 0.85);
    color: white;
    font-size: max(5vw, 18px);
    z-index: 20;
  }
  #startOverlay button.selected {
    background-color: green;
    color: rgb(255, 255, 255);
  }
  #startOverlay button.music-selected {
    background-color: blue;
    color: white;
  }
  #startOverlay button, #gameOverOverlay button {
    margin: 10px;
    padding: 10px 20px;
        font-family: 'Courier New', Courier, monospace;
    font-size: 46px;
    background-color: rgb(208, 208, 208);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    color: rgb(0, 0, 0);
  }
  #startOverlay button:hover, #gameOverOverlay button:hover {
    background-color: darkgray;
  }
#touchControls {
  display: grid;
  grid-template-areas:
    ". up ."
    "left . right"
    ". down .";
  grid-template-columns: 60px 60px 60px;
  grid-template-rows: 60px 60px 60px;
  gap: 68px;

  justify-content: center;
  align-items: center;
  margin: 20px auto;
}

#touchControls > button {
  width: 100px;
  height: 100px;
  font-size: 30px;
  font-weight: bold;
  background: linear-gradient(to bottom, #555, #333);
  border-radius: 10px;
  color: white;
  border: 2px solid #999;
  box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
  cursor: pointer;

  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s, transform 0.1s;
}

#touchControls > button:active {
  transform: scale(0.9);
  background: linear-gradient(to bottom, #444, #222);
}


#touchControls2 > button {
  width: 200px;
  height: 60px;
  font-size: 20px;
  font-weight: bold;
  background: linear-gradient(to bottom, #555, #333);
  border-radius: 10px;
  color: white;
  border: 2px solid #999;
  box-shadow: 2px 2px 5px rgba(0,0,0,0.5);

  transition: background 0.2s, transform 0.1s;
}


#touchControls .up    { grid-area: up; }
#touchControls .down  { grid-area: down; }
#touchControls .left  { grid-area: left; }
#touchControls .right { grid-area: right; }

@media (max-width: 400px) {
  #touchControls {
    grid-template-columns: 40px 40px 40px;
    grid-template-rows: 40px 40px 40px;
    gap: 5px;
  }
  #touchControls > button {
    width: 40px;
    height: 40px;
    font-size: 16px;
  }
}


  #startOverlay button.mode-select:hover {
  background-color: darkgreen;
  color:white;
}

#startOverlay button.music-select:hover {
  background-color: rgb(103, 103, 250);
  color: white;
}
#startOverlay button.selected {
  background-color: green;
  color: rgba(255, 255, 255, 0.851);

}

#startOverlay button.music-selected {
  background-color: rgb(96, 96, 171);
  color: rgb(255, 255, 255);
}

  @media (max-width: 400px) {
    #touchControls > button {
      width: 40px; height: 40px;
      font-size: 16px;
    }
    #startOverlay button, #gameOverOverlay button {
      font-size: 14px;
      padding: 8px 16px;
    }
    #score {
      font-size: 14px;
    }
  }

  #score, #touchControls2 {
  display: inline-block;
  vertical-align: middle; /* opcional, para alinhar verticalmente */
  margin-right: 10px;     /* espaçamento entre eles */
}

#startButtonContainer button {
  background-color: #ffffff; /* verde padrão */
  color: rgb(0, 0, 0);
  border: none;
      font-family: 'Courier New', Courier, monospace;
  padding: 50px 120px;
  font-size: 56px;
  cursor: pointer;
  border-radius: 5px;
  transition: background-color 0.3s ease;
}

#startButtonContainer button:hover {
  background-color: #ff9100; /* verde mais escuro ao passar o mouse */
    color: rgb(255, 255, 255);

}


</style>
</head>
<body>

<div id="score" style="display: inline-block; vertical-align: middle; margin-right: 20px;">
  Score: 0 | Vidas: 0
</div>
<div id="touchControls2" role="group" aria-label="Pause (P)" style="display: inline-block; vertical-align: middle;">
  <button type="button" onclick="togglePause()">Pause (P)</button>
</div>


   
<canvas id="gameCanvas" width="640" height="640"></canvas>
<div id="gameOverOverlay" role="alert" aria-live="assertive"></div>
<audio id="audioFundo" preload="auto"></audio>

<div id="touchControls" role="group"  style= "margin-top: 100px; "aria-label="Controles do jogo para toque">


  <button type="button" class="up" onclick="movePlayer('up')">W</button>
  <button type="button" class="left" onclick="movePlayer('left')">A</button>
  <button type="button" class="right" onclick="movePlayer('right')">D</button>
  <button type="button" class="down" onclick="movePlayer('down')">S</button>


</div>
<!-- Assinatura -->
<footer style="text-align: center; margin-top: 50px; font-family: sans-serif; font-size: 14px; color: #555;">
  Desenvolvido por <strong>Ivan Moriá Borges</strong> — 
  <a href="https://ivanmoria.github.io" target="_blank" rel="noopener noreferrer">ivanmoria.github.io</a>
</footer>
<div id="startOverlay">
  <div style="margin-top: -10%;">Escolha o modo:</div>
  <button class="mode-select" onclick="setMode('normal')">Modo Normal</button>
  <button class="mode-select" onclick="setMode('hardcore')">Modo Hardcore</button>

  <div style="margin-top: 20px;">Escolha a música:</div>

  <div style="display: flex; gap: 10px; margin-bottom: 10px;">
    <button class="music-select" onclick="setMusic('musica1.mp3', 'layers1.csv')">Música 1</button>
    <button class="music-select" onclick="setMusic('musica2.mp3', 'layers2.csv')">Música 2</button>
  </div>
  <div style="display: flex; gap: 10px;">
    <button class="music-select" onclick="setMusic('musica3.mp3', 'layers3.csv')">Música 3</button>
    <button class="music-select" onclick="setMusic('musica4.mp3', 'layers4.csv')">Música 4</button>
  </div>

  <div id="startButtonContainer"></div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    setMusic('musica1.mp3', 'layers1.csv');

    // Marca o botão 'Música 1' como ativo (se quiser destacar visualmente)
    const musicBtn = document.querySelector("button.music-select[onclick=\"setMusic('musica1.mp3', 'layers1.csv')\"]");
    if (musicBtn) {
      musicBtn.classList.add('active'); // classe para estilo ativo, se tiver
    }
  });
</script>


<script>
  document.addEventListener('DOMContentLoaded', function() {
    setMode('normal');

    // Marca o botão 'Modo Normal' como ativo (se houver estilo para isso)
    const normalBtn = document.querySelector("button.mode-select[onclick=\"setMode('normal')\"]");
    if (normalBtn) {
      normalBtn.classList.add('active'); // supondo que a classe 'active' destaca o botão
    }
  });
</script>


<script>
(() => {
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');

  const ROWS = 8, COLS = 8;
  let WIDTH = canvas.width, HEIGHT = canvas.height;
  let SQUARE_SIZE = WIDTH / COLS;

  const COLORS = {
    YELLOW: '#FFFF00',
    RED: '#FF0000',
    BLUE: '#0000FF',
    GREEN: '#00FF00',
    LIGHT_BROWN: '#DEB887',
    BROWN: '#8B4513'
  };

  let gameMode = null;
  let musicFile = null;
  let csvFile = null;
  let laserTimes = [];

  let playerPos = { row: 7, col: 0 };
  let dangerPositions = [];
  let targetPos = null;
  let greenPos = null;

  let score = 0;
  let lives = 0;
  let gameOver = false;
  let highScores = [];

  let lastScoreBeforeReset = null;

  let laserIndex = 0;
  let startTime = null;
  let damageCooldown = false;
  let pauseStartTime = null;
  let totalPausedDuration = 0;

  let isPaused = false;
  const scoreDiv = document.getElementById('score');
  const gameOverOverlay = document.getElementById('gameOverOverlay');
  const audioFundo = document.getElementById('audioFundo');
  const startOverlay = document.getElementById('startOverlay');
  const startButtonContainer = document.getElementById('startButtonContainer');
  let gameEnded = false;

function togglePause() {
  const pauseBtn = document.querySelector('button[onclick="togglePause()"]');

  isPaused = !isPaused;

  if (isPaused) {
    pauseStartTime = performance.now();
    audioFundo.pause();
    if (pauseBtn) pauseBtn.textContent = "Pause (P)";
    
    // Exibe overlay com scores (tipo tela de game over, mas com "Continuar")
    const sessionHighScore = Math.max(
      lastScoreBeforeReset || 0,
      highScores.length ? Math.max(...highScores) : 0
    );
    const highList = highScores.map((s, i) => `<div>${i + 1}ª tentativa: ${s}</div>`).join('');

    gameOverOverlay.innerHTML = `
      <div style="text-align:center; margin-top: -15%;color:white; font-size: 24px;">
        <strong>Jogo Pausado</strong><br>
        Maior Score nesta sessão: ${sessionHighScore}<br>
        Score atual: ${score}<br>
        <br>
        <strong>Scores anteriores:</strong><br>
        ${highList || '<div>Nenhuma tentativa anterior</div>'}<br><br>
        <button id="continueBtn">Continuar (P)</button> 
      </div>`;
    gameOverOverlay.style.visibility = 'visible';

    // Liga botão continuar
    const continueBtn = document.getElementById('continueBtn');
    if (continueBtn) {
      continueBtn.onclick = () => {
        isPaused = false;
        totalPausedDuration += performance.now() - pauseStartTime;
        pauseStartTime = null;
        gameOverOverlay.style.visibility = 'hidden';
        if (pauseBtn) pauseBtn.textContent = "Pause (P)";
        audioFundo.play().catch(err => console.log('Erro ao tocar áudio:', err));
        requestAnimationFrame(gameLoop);
      };
    }

  } else {
   // Continuar (se chamado por tecla P)
    isPaused = false;
    totalPausedDuration += performance.now() - pauseStartTime;
    pauseStartTime = null;
    gameOverOverlay.style.visibility = 'hidden';
    if (pauseBtn) pauseBtn.textContent = "Pause (P)";
    audioFundo.play().catch(err => console.log('Erro ao tocar áudio:', err));
    requestAnimationFrame(gameLoop);
  }

  }


window.togglePause = togglePause;

  window.setMode = function(mode) {
    gameMode = mode;
    document.querySelectorAll('#startOverlay button.mode-select').forEach(btn => {
      btn.classList.toggle('selected', btn.textContent.toLowerCase().includes(mode.toLowerCase()));
    });
    checkStartReady();
  };

  window.setMusic = function(audioSrc, csvSrc) {
    musicFile = audioSrc;
    csvFile = csvSrc;
    document.querySelectorAll('#startOverlay button.music-select').forEach(btn => {
      const match =
        (audioSrc.includes('musica1') && btn.textContent.includes('Música 1')) ||
        (audioSrc.includes('musica2') && btn.textContent.includes('Música 2')) ||
        (audioSrc.includes('musica3') && btn.textContent.includes('Música 3')) ||
        (audioSrc.includes('musica4') && btn.textContent.includes('Música 4'));
      btn.classList.toggle('music-selected', match);
    });
    checkStartReady();
  };

  function checkStartReady() {
    if (gameMode && musicFile && csvFile) {
      startButtonContainer.innerHTML = '<button class="start-btn" onclick="startGame()">Iniciar Jogo</button>';
    }
  }


  async function loadCSV() {
    try {
      const response = await fetch(csvFile);
      if (!response.ok) throw new Error('Erro ao carregar CSV');
      const text = await response.text();
      const lines = text.trim().split('\n');
      laserTimes = lines.slice(1).map(line => parseFloat(line.split(',')[0])).filter(t => !isNaN(t));
    } catch {
      laserTimes = [2, 5, 8, 12, 15];
    }
  }

  function drawBoard() {
    WIDTH = canvas.width;
    HEIGHT = canvas.height;
    SQUARE_SIZE = WIDTH / COLS;
    for (let r = 0; r < ROWS; r++) {
      for (let c = 0; c < COLS; c++) {
        ctx.fillStyle = (r + c) % 2 === 0 ? COLORS.LIGHT_BROWN : COLORS.BROWN;
        ctx.fillRect(c * SQUARE_SIZE, r * SQUARE_SIZE, SQUARE_SIZE, SQUARE_SIZE);
      }
    }
  }

  function drawElements() {
    const radius = SQUARE_SIZE / 3;
    for (const pos of dangerPositions) {
      ctx.fillStyle = COLORS.YELLOW;
      ctx.beginPath();
      ctx.arc(pos.col * SQUARE_SIZE + SQUARE_SIZE / 2, pos.row * SQUARE_SIZE + SQUARE_SIZE / 2, radius, 0, Math.PI * 2);
      ctx.fill();
    }
    if (targetPos) {
      ctx.fillStyle = COLORS.BLUE;
      ctx.beginPath();
      ctx.arc(targetPos.col * SQUARE_SIZE + SQUARE_SIZE / 2, targetPos.row * SQUARE_SIZE + SQUARE_SIZE / 2, radius, 0, Math.PI * 2);
      ctx.fill();
    }
    if (greenPos) {
      ctx.fillStyle = COLORS.GREEN;
      ctx.beginPath();
      ctx.arc(greenPos.col * SQUARE_SIZE + SQUARE_SIZE / 2, greenPos.row * SQUARE_SIZE + SQUARE_SIZE / 2, radius, 0, Math.PI * 2);
      ctx.fill();
    }
    ctx.fillStyle = COLORS.RED;
    ctx.beginPath();
    ctx.arc(playerPos.col * SQUARE_SIZE + SQUARE_SIZE / 2, playerPos.row * SQUARE_SIZE + SQUARE_SIZE / 2, radius, 0, Math.PI * 2);
    ctx.fill();
  }

  function spawnDangerPositions() {
    const positions = [];
    for (let r = 0; r < ROWS; r++) {
      for (let c = 0; c < COLS; c++) {
        const isOccupied =
          (r === playerPos.row && c === playerPos.col) ||
          (targetPos && r === targetPos.row && c === targetPos.col) ||
          (greenPos && r === greenPos.row && c === greenPos.col);
        if (!isOccupied) positions.push({ row: r, col: c });
      }
    }
    return positions.sort(() => 0.5 - Math.random()).slice(0, 10);
  }

  function spawnTarget() {
    const positions = [];
    for (let r = 0; r < ROWS; r++) {
      for (let c = 0; c < COLS; c++) {
        const occupied = (r === playerPos.row && c === playerPos.col) ||
          dangerPositions.some(p => p.row === r && p.col === c) ||
          (greenPos && r === greenPos.row && c === greenPos.col);
        if (!occupied) positions.push({ row: r, col: c });
      }
    }
    return positions.length ? positions[Math.floor(Math.random() * positions.length)] : null;
  }

  function spawnGreen() {
    const positions = [];
    for (let r = 0; r < ROWS; r++) {
      for (let c = 0; c < COLS; c++) {
        const occupied = (r === playerPos.row && c === playerPos.col) ||
          (targetPos && r === targetPos.row && c === targetPos.col) ||
          dangerPositions.some(p => p.row === r && p.col === c);
        if (!occupied) positions.push({ row: r, col: c });
      }
    }
    greenPos = positions.length ? positions[Math.floor(Math.random() * positions.length)] : null;
  }

  function updateScore() {
    scoreDiv.textContent = `Score: ${score} | Vidas: ${lives}`;
  }

  function update() {
    if (!startTime) startTime = performance.now();
    const elapsed = (performance.now() - startTime - totalPausedDuration) / 1000;

    if (laserIndex < laserTimes.length && elapsed >= laserTimes[laserIndex]) {
      dangerPositions = spawnDangerPositions();
      laserIndex++;
    }

    if (!targetPos) targetPos = spawnTarget();

    if (targetPos && playerPos.row === targetPos.row && playerPos.col === targetPos.col) {
      score++;
      targetPos = null;
      updateScore();
      if (score % 10 === 0 && !greenPos) spawnGreen();
    }

    if (greenPos && playerPos.row === greenPos.row && playerPos.col === greenPos.col) {
      score += 3;
      lives += 1;
      greenPos = null;
      updateScore();
    }

    const hitDanger = dangerPositions.some(p => p.row === playerPos.row && p.col === playerPos.col);
    if (hitDanger && !damageCooldown) {
      lastScoreBeforeReset = score;
      if (gameMode === 'normal') {
        lives > 0 ? lives-- : score = 0;
      } else if (gameMode === 'hardcore') {
        score = 0;
        if (lives > 0) {
          lives--;
        } else {
          gameOver = true;
          audioFundo.pause();
          showGameOver();
          if (!highScores.includes(lastScoreBeforeReset)) highScores.push(lastScoreBeforeReset);
        }
      }
      updateScore();
      damageCooldown = true;
      setTimeout(() => damageCooldown = false, 1000);
    }
  }

  function draw() {
    ctx.clearRect(0, 0, WIDTH, HEIGHT);
    drawBoard();
    drawElements();
  }

  function gameLoop() {
    if (isPaused || gameOver) return;
    update();
    draw();
    requestAnimationFrame(gameLoop);
  }

  function showGameOver() {
    const sessionHighScore = Math.max(lastScoreBeforeReset || 0, ...highScores);
    const highList = highScores.map((s, i) => `<div>${i + 1}ª tentativa: ${s}</div>`).join('');
    gameOverOverlay.innerHTML = `
      <div style="text-align:center;  margin-top: -15%;color:white; font-size: 24px;">
        Fim do Jogo!<br>
        Maior Score nesta sessão: ${sessionHighScore}<br>
        ${lastScoreBeforeReset !== null ? `Último score antes de morrer: ${lastScoreBeforeReset}<br>` : ''}
        <br><strong>Scores anteriores:</strong><br>${highList || 'Nenhuma tentativa anterior'}<br><br>
   
        <button id="restartBtn">Reiniciar (R)</button>
      </div>`;
    gameOverOverlay.style.visibility = 'visible';
    document.getElementById('restartBtn').onclick = resetGame;
  }

  function hideGameOver() {
    gameOverOverlay.style.visibility = 'hidden';
  }

  function resetGame() {
    playerPos = { row: 7, col: 0 };
    score = 0;
    lives = 0;
    dangerPositions = [];
    targetPos = null;
    greenPos = null;
    startTime = null;
    laserIndex = 0;
    gameOver = false;
    gameEnded = false;
    damageCooldown = false;
    lastScoreBeforeReset = null;
    totalPausedDuration = 0;
    updateScore();
    hideGameOver();
    audioFundo.currentTime = 0;
    audioFundo.play().catch(err => console.log('Erro ao tocar áudio:', err));
    gameLoop();
  }

  window.movePlayer = function(dir) {
    if (gameOver) return;
    let { row, col } = playerPos;
    if (dir === 'up' && row > 0) row--;
    if (dir === 'down' && row < ROWS - 1) row++;
    if (dir === 'left' && col > 0) col--;
    if (dir === 'right' && col < COLS - 1) col++;
    playerPos = { row, col };
    update();
    draw();
  };

  window.startGame = function() {
    loadCSV().then(() => {
      startOverlay.style.display = 'none';
      audioFundo.src = musicFile;
      audioFundo.currentTime = 0;
      audioFundo.play().catch(err => console.log('Erro ao tocar áudio:', err));
      resetGame();
    });
  };

    window.addEventListener('keydown', e => {
    if (gameOver && e.code === 'KeyR') return document.getElementById('restartBtn')?.click();

    const key = e.key.toLowerCase();

    if (key === 'p') {
      togglePause();
      return;
    }

   
    const keys = { w: 'up', a: 'left', s: 'down', d: 'right' };
    if (keys[e.key.toLowerCase()]) movePlayer(keys[e.key.toLowerCase()]);
  });

  audioFundo.addEventListener('ended', () => {
    if (!gameOver) {
      gameOver = true;
      if (score > 0 && !highScores.includes(score)) highScores.push(score);
      showGameOver();
    }
  });

  draw(); // desenha tabuleiro inicial
})();
</script>




</body>
</html>
