<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teste do Tempo Espontâneo</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
    <div class="container" style="align-items: center;">
        <h1>Teste do Tempo Espontâneo</h1>
        <p>Pressione o botão abaixo ou a tecla <strong>espaço</strong> 21 vezes para marcar sua pulsação. O tempo será calculado automaticamente.</p>
        <button style="width: 200px; height:200px;" id="pulseButton">Clique para marcar a batida</button>
        <div id="result" class="hidden">
            <p>Tempo total: <span id="totalTime">0</span></p>
            <p>BPM: <span id="bpm">0</span></p>
            <h2>Instantes das batidas:</h2>
            <ul id="timeList"></ul>
            <h2>Gráfico de Batidas e IOI</h2>
            <canvas id="foiChart" width="400" height="200"></canvas>
          </div>
          <p id="instructions">Batidas: <span id="count">0</span>/21</p>
        </div>
      <style>.hidden {
        display: none;
      }
      </style>
  <script>
 
    document.addEventListener("DOMContentLoaded", () => {
        const pulseButton = document.getElementById("pulseButton");
        const result = document.getElementById("result");
        const totalTimeElement = document.getElementById("totalTime");
        const bpmElement = document.getElementById("bpm");
        const timeList = document.getElementById("timeList");
        const countElement = document.getElementById("count");
        const instructions = document.getElementById("instructions");
        const foiChartCanvas = document.getElementById("foiChart");
      
        let count = 0;
        let startTime = null;
        const beatTimes = []; // Armazena os instantes de cada batida em milissegundos
      
        // Função para registrar a batida
        function markPulse() {
          const currentTime = new Date();
      
          if (count === 0) {
            // Iniciar o cronômetro na primeira batida
            startTime = currentTime;
            beatTimes.push(0); // Instante da primeira batida em ms
            count++;
            countElement.textContent = count;
          } else if (count < 20) {
            // Registrar instantes intermediários
            const timeElapsed = currentTime - startTime; // Instante atual em ms
            beatTimes.push(timeElapsed);
            count++;
            countElement.textContent = count;
          } else if (count === 20) {
            // Finalizar na 21ª batida
            const timeElapsed = currentTime - startTime; // Instante final em ms
            beatTimes.push(timeElapsed);
      
            // Calcular e exibir o tempo total em ms
            const totalTime = currentTime - startTime;
            totalTimeElement.textContent = `${totalTime} ms`;
      
            // Calcular o BPM (arredondado para inteiro)
            const totalMinutes = totalTime / (1000 * 60); // Tempo total em minutos
            const bpm = Math.round(20 / totalMinutes); // Número de batidas (21-1)
            bpmElement.textContent = bpm;
      
            // Exibir os instantes de cada batida em ms
            timeList.innerHTML = beatTimes
              .map((time, index) => `<li>Batida ${index + 1}: ${time} ms</li>`)
              .join("");
      
            // Calcular o FOI (Inter-Onset Interval)
            const foi = [];
            for (let i = 1; i < beatTimes.length; i++) {
              foi.push(beatTimes[i] - beatTimes[i - 1]);
            }
      
            // Calcular a Taxa de Variação do IOI (aceleração/desaceleração)
            const rateOfChange = [];
            for (let i = 2; i < foi.length; i++) {
              const change = foi[i] - foi[i - 1]; // Diferença entre IOIs consecutivos
              rateOfChange.push(change);
            }
      
            // Plotar o gráfico de IOI e aceleração/desaceleração
            plotFOIChart(foi, rateOfChange, beatTimes);
      
            // Mostrar o resultado e desabilitar o botão
            result.classList.remove("hidden");
            pulseButton.disabled = true;
            instructions.textContent = "Teste concluído!";
          }
        }
      
        // Função para plotar o gráfico de IOI, Taxa de Variação do IOI e Instantes das Batidas
        function plotFOIChart(foi, rateOfChange, beatTimes) {
          // Calculando os tempos totais da atividade (diferença entre batida e tempo inicial)
          const timeLabels = beatTimes.map(time => time); // Instantes das batidas em ms
      
          new Chart(foiChartCanvas, {
            type: "line",
            data: {
              labels: timeLabels, // Usando o tempo total decorrido de cada batida
              datasets: [
                {
                  label: "Intervalo entre Batidas (IOI) - ms",
                  data: foi,
                  borderColor: "red",
                  backgroundColor: "rgba(255, 0, 0, 0.1)",
                  fill: true,
                  yAxisID: "y1", // Usando o eixo Y primário
                  borderWidth: 2,
                  pointRadius: 5, // Adiciona marcadores visíveis para cada ponto
                },
                {
                  label: "Taxa de Variação do IOI (ms)",
                  data: rateOfChange,
                  borderColor: "green",
                  backgroundColor: "rgba(0, 255, 0, 0.1)",
                  fill: false,
                  yAxisID: "y1", // Usando o mesmo eixo Y
                  borderWidth: 2,
                  pointRadius: 3, // Adiciona marcadores visíveis para cada ponto
                  tension: 0.2, // Linha mais suave para representar variações
                }
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  display: true,
                },
              },
              scales: {
                x: {
                  title: {
                    display: true,
                    text: "Tempo Total da Atividade (ms)",
                  },
                  ticks: {
                    autoSkip: false, // Desabilitar o autoSkip para controlar os intervalos manualmente
                    maxRotation: 0,  // Impedir que os números se inclinem
                  },
                },
                y1: {
                  title: {
                    display: true,
                    text: "Valor (ms)",
                  },
                },
              },
            },
          });
        }
      
        // Adicionar evento de clique ao botão
        pulseButton.addEventListener("click", markPulse);
      
        // Adicionar evento para a tecla espaço
        document.addEventListener("keydown", (event) => {
          if (event.code === "Space" && !pulseButton.disabled) {
            markPulse();
            event.preventDefault(); // Prevenir rolagem da página ao pressionar espaço
          }
        });
      });
      

      
  </script>
</body>
</html>
