<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Painel de Controle</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #121212;
      color: #fff;
      margin: 0;
      padding: 20px;
      overflow-x: hidden;
    }

    h1 {
      text-align: center;
      margin-bottom: 10px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      margin-bottom: 30px;
    }

    .card {
      background: #1e1e1e;
      padding: 15px 15px 10px 15px;
      margin: 10px;
      border-radius: 10px;
      flex: 1 1 300px;
      max-width: 400px;
    }

    .card h2 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 1.3em;
      color: #f0f0f0;
    }

    button {
      margin: 5px 5px 5px 0;
      padding: 10px 14px;
      font-size: 1em;
      background: #333;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
      user-select: none;
    }

    button:hover {
      background: #555;
    }

    input[type=number], input[type=text] {
      width: 140px;
      padding: 6px 8px;
      font-size: 1em;
      border-radius: 5px;
      border: none;
      margin-left: 10px;
      background: #333;
      color: white;
    }

    label {
      font-size: 1em;
      vertical-align: middle;
      margin-left: 10px;
      display: inline-block;
      margin-bottom: 10px;
    }

    .participant-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }

    .participant-name-input {
      flex-shrink: 0;
      min-width: 140px;
    }

    .preview-card {
      width: 100%;
      background: #1e1e1e;
      padding: 15px 15px 10px 15px;
      border-radius: 10px;
      margin: 0 auto 20px auto;
      overflow: hidden;
    }

    .preview-card h2 {
      margin-top: 0;
      margin-bottom: 10px;
      text-align: center;
    }

    .preview-card iframe {
      width: 100%;
      height: 280px;
      border: none;
      border-radius: 8px;
      display: block;
    }

    .update-name-btn {
      margin-left: 10px;
      font-size: 16px;
      background: #c0392b; /* vermelho */
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
      user-select: none;
    }

    .update-name-btn.checked {
      background: #27ae60; /* verde */
      color: #fff;
    }

    .update-name-btn:hover {
      transform: scale(1.2);
    }

    .update-name-btn:focus {
      outline: none;
      box-shadow: 0 0 6px #27ae60;
    }

    /* Estilo base do slider */
    input[type=range] {
      width: 100%;
      height: 8px;
      background: #555;
      border-radius: 5px;
      outline: none;
      margin: 0;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    input[type=range]:hover {
      background: #777;
    }

    /* Track do slider no Firefox */
    input[type=range]::-moz-range-track {
      background: #555;
      border-radius: 5px;
    }

    /* Thumb do slider no Chrome, Safari, Edge */
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 22px;
      height: 22px;
      background: #27ae60;
      border-radius: 50%;
      border: 2px solid #fff;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      box-shadow: 0 0 6px rgba(39, 174, 96, 0.6);
      margin-top: -7px; /* centraliza na trilha */
    }
    input[type=range]::-webkit-slider-thumb:hover {
      background: #2ecc71;
      transform: scale(1.2);
    }

    /* Thumb do slider no Firefox */
    input[type=range]::-moz-range-thumb {
      width: 22px;
      height: 22px;
      background: #27ae60;
      border-radius: 50%;
      border: 2px solid #fff;
      cursor: pointer;
      box-shadow: 0 0 6px rgba(39, 174, 96, 0.6);
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    input[type=range]::-moz-range-thumb:hover {
      background: #2ecc71;
      transform: scale(1.2);
    }

    /* Container dos ticks */
    .slider-ticks {
      display: flex;
      justify-content: space-between;
      padding: 0 5px;
      font-size: 0.85em;
      color: #ccc;
      user-select: none;
      margin-top: 6px;
    }

    /* Bot√µes dos pap√©is extras abaixo do slider */
    .role-buttons {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .role-buttons button {
      flex: 1 1 110px;
      font-size: 0.9em;
      padding: 6px 8px;
      background: #444;
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }
    .role-buttons button:hover {
      background: #666;
    }
.random-mode h2 {
  margin-bottom: 15px;
  text-align: center;
}

/* Bot√µes Voltar/Avan√ßar lado a lado, centralizados */
.random-mode .nav-buttons {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-bottom: 20px;
}

/* Linha com start, label, input e stop alinhados horizontalmente */
.random-mode .control-row {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 15px;
  flex-wrap: wrap; /* para ajustar em telas menores */
  margin-bottom: 20px;
}

.random-mode label {
  font-size: 1em;
  color: white;
  white-space: nowrap;
}

/* Input de n√∫mero com tamanho fixo e estilo consistente */
.random-mode input[type="number"] {
  width: 60px;
  padding: 5px 8px;
  font-size: 1em;
  border-radius: 5px;
  border: none;
  background: rgba(255,255,255,0.1);
  color: white;
  text-align: center;
}

/* Bot√£o export centralizado */
.random-mode .export-row {
  display: flex;
  justify-content: center;
}

/* Bot√£o toggle verde/vermelho */
#toggleRandomBtn {
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 10px 14px;
  font-size: 1em;
  cursor: pointer;
  user-select: none;
  transition: background-color 0.3s ease;
  background-color: #27ae60; /* verde inicial */
}
  </style>
</head>
<body>
  <h1 id="page-title">Painel de Controle</h1>

<div id="lang-switcher" style="position:absolute; top:20px; right:20px;">
  <button id="toggle-lang">PT / EN</button>
</div>


  <div class="row">
    <!-- Participante 1 -->
    <div class="card">
      <h2>
        Participante 1:
        <input type="text" id="leftNameInput" class="participant-name-input" placeholder="insert name" />
        <button id="leftUpdateBtn" class="update-name-btn" title="Atualizar Nome">‚úîÔ∏è</button>
      </h2>
      <div class="participant-row" style="flex-direction: column; gap: 6px;">
        <input
          type="range"
          id="leftRoleSlider"
          min="0"
          max="4"
          step="1"
          value="0"
          aria-label="Selecionar papel participante 1"
        />
        <br>
        <span id="leftRoleLabel" style="min-width: 90px; text-align: center; font-weight: bold; user-select:none;">
          Dependent
        </span>

        <div class="role-buttons" id="leftRoleButtons">
          <button data-role="Dependent">Dependent</button>
          <button data-role="Follower">Follower</button>
          <button data-role="Partner">Partner</button>
          <button data-role="Leader">Leader</button>
          <button data-role="Resister">Resister</button>
        </div>
      </div>
    </div>

    <!-- Participante 2 -->
    <div class="card">
      <h2>
        Participante 2:
        <input type="text" id="rightNameInput" class="participant-name-input" placeholder="insert name" />
        <button id="rightUpdateBtn" class="update-name-btn" title="Atualizar Nome">‚úîÔ∏è</button>
      </h2>
      <div class="participant-row" style="flex-direction: column; gap: 6px;">
        <input
          type="range"
          id="rightRoleSlider"
          min="0"
          max="4"
          step="1"
          value="0"
          aria-label="Selecionar papel participante 2"
        />
<br>
        <span id="rightRoleLabel" style="min-width: 90px; text-align: center; font-weight: bold; user-select:none;">
          Dependent
        </span>

        <div class="role-buttons" id="rightRoleButtons">
          <button data-role="Dependent">Dependent</button>
          <button data-role="Follower">Follower</button>
          <button data-role="Partner">Partner</button>
          <button data-role="Leader">Leader</button>
          <button data-role="Resister">Resister</button>
        </div>
      </div>
    </div>

<!-- Aleat√≥rio -->
<div class="card random-mode">
  <h2 id="random-title">üîÄ Modo Aleat√≥rio</h2>

  <div class="nav-buttons">
    <button id="prev-btn" onclick="prevRandom()">‚¨ÖÔ∏è Voltar</button>
    <button id="next-btn" onclick="nextRandom()">Avan√ßar ‚û°Ô∏è</button>
  </div>

  <div class="control-row">
    <button id="toggleRandomBtn" onclick="toggleRandom()">Iniciar</button>

    <label for="minInterval" id="minIntervalLabel">Tempo m√≠nimo (s):</label>
    <input id="minInterval" type="number" min="1" value="5" />
  </div>

<div class="export-row" style="gap: 10px; display: flex; justify-content: center; align-items: center;">
  <button id="export-csv-btn" onclick="exportCSV()">üì• Exportar CSV</button>

  <button id="recordToggleBtn">üé• Gravar Webcam</button>
</div>

<div id="recorderContainer" style="display:none; margin-top: 15px; text-align: center;">
  <video id="previewVideo" autoplay muted playsinline style="width: 320px; height: 240px; background: black; border-radius: 8px;"></video>
  <div style="margin-top: 10px;">
    <button id="startRecBtn">Iniciar Grava√ß√£o</button>
    <button id="stopRecBtn" disabled>Parar Grava√ß√£o</button>
  </div>

  <div id="recordTimer" style="font-size: 1.2em; margin-top: 8px; color: #27ae60; user-select:none;">00:00</div>

  <h3 id="video-recorded-title">V√≠deo Gravado:</h3>
  <!-- preview oculto -->
  <video id="recordedVideo" controls style="width: 320px; height: 240px; background: black; border-radius: 8px; display:none;"></video>

  <div style="margin-top: 10px;">
    <!-- bot√£o vis√≠vel -->
    <button id="downloadRecBtn" style="display:inline-block;">‚¨áÔ∏è Baixar V√≠deo</button>
  </div>
</div>


</div>
  </div>

  <div class="preview-card">
    <h2>  <p style="text-align: center; margin-top:-10px;margin-bottom: 10px;">
    <a id="open-projection" href="tela.html" target="_blank" style="color: #00BFFF; text-decoration: none; font-weight: bold;">
      üîó Abrir tela de proje√ß√£o em nova aba
    </a>
  </p></h2>

    <iframe style="margin-bottom:-20px;"     src="tela.html"></iframe>
  </div>

<script>
  const channel = new BroadcastChannel("improvisacao");
  const roles = ["Dependent", "Follower", "Partner", "Leader", "Resister"];

  // language maps
  const roleMapEN = ["Dependent", "Follower", "Partner", "Leader", "Resister"];
  const roleMapPT = ["Dependente", "Seguidor", "Parceiro", "L√≠der", "Resistente"];

  let currentLang = "pt"; // "pt" or "en"

  // UI elements
  const pageTitle = document.getElementById('page-title');
  const toggleLangBtn = document.getElementById('toggle-lang');

  const leftInput = document.getElementById('leftNameInput');
  const rightInput = document.getElementById('rightNameInput');
  const leftBtn = document.getElementById('leftUpdateBtn');
  const rightBtn = document.getElementById('rightUpdateBtn');

  const leftSlider = document.getElementById('leftRoleSlider');
  const rightSlider = document.getElementById('rightRoleSlider');
  const leftLabel = document.getElementById('leftRoleLabel');
  const rightLabel = document.getElementById('rightRoleLabel');

  const leftRoleButtons = document.getElementById('leftRoleButtons');
  const rightRoleButtons = document.getElementById('rightRoleButtons');

  const toggleRandomBtn = document.getElementById('toggleRandomBtn');
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');
  const minIntervalLabel = document.getElementById('minIntervalLabel');
  const exportCsvBtn = document.getElementById('export-csv-btn');
  const recordToggleBtn = document.getElementById('recordToggleBtn');
  const videoRecordedTitle = document.getElementById('video-recorded-title');
  const openProjectionLink = document.getElementById('open-projection');
  const randomTitle = document.getElementById('random-title');

  let intervalId;
  let history = [];
  let currentIndex = -1;
  let startTime = null;
  let isRandomRunning = false;

  // Quem √© leader: "left" ou "right"
  let leaderSide = "left";
  let leaderRoundsLeft = 3;
  let nonLeaderIndex = 0;
  const allNonLeaderRoles = ["Dependent", "Follower", "Partner", "Resister"];
  let nonLeaderRoles = [...allNonLeaderRoles];

  // Vari√°veis para nomes
  let savedLeftName = "";
  let savedRightName = "";

  // last role keys (english) to be able to re-localize on language change
  let leftRoleKey = roles[0];
  let rightRoleKey = roles[0];

  // Fun√ß√£o para embaralhar array (Fisher-Yates)
  function shuffleArray(array) {
    for (let i = array.length -1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  shuffleArray(nonLeaderRoles);

  function updateButtonColor(inputElem, btnElem, savedName) {
    if (inputElem.value.trim() === savedName && savedName !== "") {
      btnElem.classList.add('checked');
    } else {
      btnElem.classList.remove('checked');
    }
  }
  function sendLeftName() {
    savedLeftName = leftInput.value.trim() || (currentLang === "pt" ? "Participante 1" : "Participant 1");
    channel.postMessage({ leftName: savedLeftName });
    updateButtonColor(leftInput, leftBtn, savedLeftName);
  }
  function sendRightName() {
    savedRightName = rightInput.value.trim() || (currentLang === "pt" ? "Participante 2" : "Participant 2");
    channel.postMessage({ rightName: savedRightName });
    updateButtonColor(rightInput, rightBtn, savedRightName);
  }
  leftInput.addEventListener('input', () => updateButtonColor(leftInput, leftBtn, savedLeftName));
  rightInput.addEventListener('input', () => updateButtonColor(rightInput, rightBtn, savedRightName));
  leftBtn.addEventListener('click', sendLeftName);
  rightBtn.addEventListener('click', sendRightName);

  // Atualiza label e slider, al√©m de destacar bot√£o correspondente
  function updateRole(side, valueOrIndex) {
    // valueOrIndex pode ser n√∫mero (index) ou string (roleKey)
    let roleKey;
    if (typeof valueOrIndex === 'number' || /^\d+$/.test(String(valueOrIndex))) {
      roleKey = roles[Number(valueOrIndex)];
    } else {
      roleKey = String(valueOrIndex);
    }

    const idx = roles.indexOf(roleKey);
    if (idx === -1) return;

    if(side === 'left') {
      leftRoleKey = roleKey;
      leftLabel.textContent = (currentLang === "pt") ? roleMapPT[idx] : roleMapEN[idx];
      leftSlider.value = idx;
      highlightRoleButton(leftRoleButtons, roleKey);
    } else {
      rightRoleKey = roleKey;
      rightLabel.textContent = (currentLang === "pt") ? roleMapPT[idx] : roleMapEN[idx];
      rightSlider.value = idx;
      highlightRoleButton(rightRoleButtons, roleKey);
    }
    // sempre enviar roleKey em ingl√™s para a proje√ß√£o/tela
    send(side, roleKey);
  }
  function highlightRoleButton(container, role) {
    [...container.children].forEach(btn => {
      btn.style.backgroundColor = (btn.dataset.role === role) ? '#27ae60' : '#444';
      btn.style.color = (btn.dataset.role === role) ? '#fff' : '#ddd';
    });
  }
  leftSlider.addEventListener('input', () => updateRole('left', leftSlider.value));
  rightSlider.addEventListener('input', () => updateRole('right', rightSlider.value));
  leftRoleButtons.addEventListener('click', e => {
    if(e.target.tagName === 'BUTTON') {
      const role = e.target.dataset.role;
      const index = roles.indexOf(role);
      updateRole('left', index);
    }
  });
  rightRoleButtons.addEventListener('click', e => {
    if(e.target.tagName === 'BUTTON') {
      const role = e.target.dataset.role;
      const index = roles.indexOf(role);
      updateRole('right', index);
    }
  });

  function initSliders() {
    updateRole('left', leftSlider.value);
    updateRole('right', rightSlider.value);
  }
  initSliders();

  function send(side, role) {
    const data = {};
    data[side] = role;
    channel.postMessage(data);
  }

  function getElapsedTime() {
    const now = new Date();
    const diff = Math.floor((now - startTime) / 1000);
    const min = String(Math.floor(diff / 60)).padStart(2, '0');
    const sec = String(diff % 60).padStart(2, '0');
    return `${min}:${sec}`;
  }

  function applyRoles(leftRole, rightRole) {
    channel.postMessage({ left: leftRole, right: rightRole });
  }

  function generateNewStep() {
    let leftRole, rightRole;

    if (leaderSide === "left") {
      leftRole = "Leader";
      rightRole = nonLeaderRoles[nonLeaderIndex % nonLeaderRoles.length];
    } else {
      rightRole = "Leader";
      leftRole = nonLeaderRoles[nonLeaderIndex % nonLeaderRoles.length];
    }

    nonLeaderIndex++;
    leaderRoundsLeft--;

    if (leaderRoundsLeft <= 0) {
      leaderSide = (leaderSide === "left") ? "right" : "left";
      leaderRoundsLeft = 3;
      nonLeaderIndex = 0;
      nonLeaderRoles = [...allNonLeaderRoles];
      shuffleArray(nonLeaderRoles);
    }

    const timestamp = getElapsedTime();
    const step = { tempo: timestamp, left: leftRole, right: rightRole };
    history.push(step);
    currentIndex = history.length - 1;

    applyRoles(leftRole, rightRole);
    updateRole('left', roles.indexOf(leftRole));
    updateRole('right', roles.indexOf(rightRole));
  }

  function startRandom() {
    stopRandom();
    history = [];
    currentIndex = -1;
    startTime = new Date();

    function loop() {
      generateNewStep();
      const minSec = parseInt(document.getElementById('minInterval').value);
      const minTime = isNaN(minSec) || minSec < 1 ? 5 : minSec;
      intervalId = setTimeout(loop, minTime * 1000);
    }

    loop();
  }

  function stopRandom() {
    if (intervalId) {
      clearTimeout(intervalId);
      intervalId = null;
    }
  }

  function prevRandom() {
    if (currentIndex > 0) {
      currentIndex--;
      const { left, right } = history[currentIndex];
      applyRoles(left, right);
      updateRole('left', roles.indexOf(left));
      updateRole('right', roles.indexOf(right));
    }
  }

  function nextRandom() {
    if (isRandomRunning) {
      generateNewStep();
    } else {
      if (currentIndex < history.length - 1) {
        currentIndex++;
        const { left, right } = history[currentIndex];
        applyRoles(left, right);
        updateRole('left', roles.indexOf(left));
        updateRole('right', roles.indexOf(right));
      } else {
        generateNewStep();
      }
    }
  }

  function exportCSV() {
    if (history.length === 0) {
      alert(currentLang === "pt" ? "Nenhuma etapa foi registrada ainda." : "No steps recorded yet.");
      return;
    }
    let csv = "tempo,left,right\n";
    history.forEach(row => {
      csv += `${row.tempo},${row.left},${row.right}\n`;
    });
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = "historico_interacao.csv";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  function toggleRandom() {
    if (isRandomRunning) {
      stopRandom();
      toggleRandomBtn.textContent = (currentLang === "pt") ? "Iniciar" : "Start";
      toggleRandomBtn.style.backgroundColor = "#27ae60"; // verde
      isRandomRunning = false;
    } else {
      startRandom();
      toggleRandomBtn.textContent = (currentLang === "pt") ? "Parar" : "Stop";
      toggleRandomBtn.style.backgroundColor = "#c0392b"; // vermelho
      isRandomRunning = true;
    }
  }

  // RECORDING UI (IIFE)
  (() => {
    const recordToggleBtn = document.getElementById("recordToggleBtn");
    const recorderContainer = document.getElementById("recorderContainer");
    const previewVideo = document.getElementById("previewVideo");
    const recordedVideo = document.getElementById("recordedVideo");
    const startRecBtn = document.getElementById("startRecBtn");
    const stopRecBtn = document.getElementById("stopRecBtn");
    const recordTimer = document.getElementById("recordTimer");
    const downloadRecBtn = document.getElementById("downloadRecBtn");

    let mediaStream = null;
    let mediaRecorder = null;
    let recordedChunks = [];

    let timerInterval = null;
    let startTime = null;

    recordToggleBtn.onclick = () => {
      if (recorderContainer.style.display === "none") {
        openRecorder();
      } else {
        closeRecorder();
      }
    };

    async function openRecorder() {
      recorderContainer.style.display = "block";
      recordToggleBtn.textContent = (currentLang === "pt") ? "‚ùå Fechar Grava√ß√£o" : "‚ùå Close Recording";

      if (!mediaStream) {
        try {
          mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
          previewVideo.srcObject = mediaStream;
        } catch (err) {
          alert((currentLang === "pt" ? "Erro ao acessar webcam/microfone: " : "Error accessing webcam/microphone: ") + err.message);
          closeRecorder();
        }
      }
    }

    function closeRecorder() {
      recorderContainer.style.display = "none";
      recordToggleBtn.textContent = (currentLang === "pt") ? "üé• Gravar Webcam" : "üé• Record Webcam";
      stopRecordingIfActive();
      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
      }
      previewVideo.srcObject = null;
      recordedVideo.style.display = "none";
      recordedVideo.src = "";
      recordTimer.textContent = "00:00";
      downloadRecBtn.style.display = "none";
    }

    function stopRecordingIfActive() {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
      }
      startRecBtn.disabled = false;
      stopRecBtn.disabled = true;
      clearInterval(timerInterval);
      timerInterval = null;
      recordTimer.textContent = "00:00";
    }

    function startTimer() {
      startTime = Date.now();
      recordTimer.textContent = "00:00";
      timerInterval = setInterval(() => {
        const elapsedMs = Date.now() - startTime;
        const totalSeconds = Math.floor(elapsedMs / 1000);
        const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, "0");
        const seconds = String(totalSeconds % 60).padStart(2, "0");
        recordTimer.textContent = `${minutes}:${seconds}`;
      }, 250);
    }

    startRecBtn.onclick = () => {
      if (!mediaStream) {
        alert(currentLang === "pt" ? "Permiss√£o para webcam/microfone n√£o concedida." : "Permission for webcam/microphone not granted.");
        return;
      }
      recordedChunks = [];
      mediaRecorder = new MediaRecorder(mediaStream);

      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };

      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: "video/webm" });
        recordedVideo.src = URL.createObjectURL(blob);
        recordedVideo.style.display = "block";
        recordedVideo.controls = true;
        recordedVideo.play();

        downloadRecBtn.style.display = "inline-block";
        downloadRecBtn.onclick = () => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.style.display = "none";
          a.href = url;
          a.download = `grava√ß√£o_${new Date().toISOString().replace(/[:.]/g, '-')}.webm`;
          document.body.appendChild(a);
          a.click();
          setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }, 100);
        };
      };

      mediaRecorder.start();
      startRecBtn.disabled = true;
      stopRecBtn.disabled = false;
      downloadRecBtn.style.display = "none";
      startTimer();
    };

    stopRecBtn.onclick = () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        startRecBtn.disabled = false;
        stopRecBtn.disabled = true;
        clearInterval(timerInterval);
        timerInterval = null;
      }
    };
  })();

  // ---------- Language / Localization ----------
  function updateRoleButtonsText() {
    // Atualiza textos dos bot√µes (dataset.role permanece em ingl√™s)
    const leftBtns = leftRoleButtons.querySelectorAll('button');
    leftBtns.forEach((btn, idx) => {
      btn.textContent = (currentLang === "pt") ? roleMapPT[idx] : roleMapEN[idx];
    });
    const rightBtns = rightRoleButtons.querySelectorAll('button');
    rightBtns.forEach((btn, idx) => {
      btn.textContent = (currentLang === "pt") ? roleMapPT[idx] : roleMapEN[idx];
    });
  }

  function updateLanguageUI() {
    const isPT = currentLang === "pt";
    pageTitle.textContent = isPT ? "Painel de Controle" : "Control Panel";
    // h2 first text nodes (Participante 1: / Participant 1:)
    try {
      const h2s = document.querySelectorAll('.card h2');
      if (h2s.length >= 2) {
        h2s[0].childNodes[0].nodeValue = isPT ? "Participante 1: " : "Participant 1: ";
        h2s[1].childNodes[0].nodeValue = isPT ? "Participante 2: " : "Participant 2: ";
      }
    } catch (e) { /* ignore */ }

    document.querySelectorAll("input[type=text]").forEach(input => {
      input.placeholder = isPT ? "insira nome" : "insert name";
    });

    // labels & buttons
    updateRoleButtonsText();

    // atualiza os labels dos pap√©is j√° mostrados
    const leftIdx = roles.indexOf(leftRoleKey);
    const rightIdx = roles.indexOf(rightRoleKey);
    if (leftIdx >= 0) leftLabel.textContent = isPT ? roleMapPT[leftIdx] : roleMapEN[leftIdx];
    if (rightIdx >= 0) rightLabel.textContent = isPT ? roleMapPT[rightIdx] : roleMapEN[rightIdx];

    // Random mode
    randomTitle.textContent = isPT ? "üîÄ Modo Aleat√≥rio" : "üîÄ Random Mode";
    prevBtn.textContent = isPT ? "‚¨ÖÔ∏è Voltar" : "‚¨ÖÔ∏è Back";
    nextBtn.textContent = isPT ? "Avan√ßar ‚û°Ô∏è" : "Next ‚û°Ô∏è";
    toggleRandomBtn.textContent = isPT ? (isRandomRunning ? "Parar" : "Iniciar") : (isRandomRunning ? "Stop" : "Start");
    minIntervalLabel.textContent = isPT ? "Tempo m√≠nimo (s):" : "Minimum time (s):";
    exportCsvBtn.textContent = isPT ? "üì• Exportar CSV" : "üì• Export CSV";
    recordToggleBtn.textContent = isPT ? "üé• Gravar Webcam" : "üé• Record Webcam";
    videoRecordedTitle.textContent = isPT ? "V√≠deo Gravado:" : "Recorded Video:";
    openProjectionLink.textContent = isPT ? "üîó Abrir tela de proje√ß√£o em nova aba" : "üîó Open projection in new tab";

    // toggle button label
    toggleLangBtn.textContent = isPT ? "PT / EN" : "EN / PT";
  }

  toggleLangBtn.addEventListener('click', () => {
    currentLang = (currentLang === "pt") ? "en" : "pt";
    updateLanguageUI();
    // envia para a tela de proje√ß√£o
    channel.postMessage({ lang: currentLang });
  });

  // send initial language to projection on load
  window.addEventListener('load', () => {
    updateLanguageUI();
    // small delay to let projection iframe load its listener
    setTimeout(() => channel.postMessage({ lang: currentLang }), 200);
  });

  // receive messages (optional: projection can reply)
  channel.onmessage = (e) => {
    const data = e.data;
    if (!data) return;
    if (data.requestLang) {
      channel.postMessage({ lang: currentLang });
    }
    // projection may request name update or language change; ignore or handle as desired
    if (data.lang && (data.lang === "pt" || data.lang === "en")) {
      // if projection changed language (clicked its own button), sync control
      if (data.lang !== currentLang) {
        currentLang = data.lang;
        updateLanguageUI();
        // re-send to make sure both in sync
        channel.postMessage({ lang: currentLang });
      }
    }
  };
</script>

</body>
</html>
